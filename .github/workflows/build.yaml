name: Build
on:
  pull_request:
    types: [opened, reopened, ready_for_review, synchronize]
  workflow_dispatch:
  push:
    branches:
      - main
    tags-ignore:
      - '**'

env:
  CARGO_TERM_COLOR: always

jobs:
  # Cross-compilation builds using `cross` tool (Linux targets + Android)
  build-cross:
    runs-on: ubuntu-latest
    env:
      RUST_BACKTRACE: full
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-musl
            features: ""
          - target: x86_64-unknown-linux-musl
            features: "--all-features"
            suffix: "-full-features"
          - target: aarch64-unknown-linux-musl
            features: ""
          - target: aarch64-unknown-linux-musl
            features: "--all-features"
            suffix: "-full-features"
          - target: aarch64-linux-android
            features: ""
          - target: aarch64-linux-android
            features: "--all-features"
            suffix: "-full-features"
    steps:
      - name: Setup | Checkout
        uses: actions/checkout@v5

      - name: Setup | Rust
        run: |
          rustup set profile minimal
          rustup toolchain install stable
          rustup default stable
          rustup override set stable

      - name: Setup | Install cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Build | Cross compile ${{ matrix.target }}
        timeout-minutes: 120
        run: |
          cross build --release --locked --target ${{ matrix.target }} --workspace ${{ matrix.features }}

      - name: PostBuild | Prepare artifacts
        run: |
          cd target/${{ matrix.target }}/release
          strip linkura-cli || true
          strip linkura-motion-cli || true

          suffix="${{ matrix.suffix }}"
          if [ -n "$suffix" ]; then
            cp linkura-cli linkura-cli${suffix}
            cp linkura-motion-cli linkura-motion-cli${suffix}
            tar czvf ../../../linkura-cli-${{ matrix.target }}${suffix}.tar.gz linkura-cli${suffix} linkura-motion-cli${suffix}
          else
            tar czvf ../../../linkura-cli-${{ matrix.target }}.tar.gz linkura-cli linkura-motion-cli
          fi
          cd -

      - name: Deploy | Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linkura-cli-${{ matrix.target }}${{ matrix.suffix }}.tar.gz
          path: linkura-cli-${{ matrix.target }}${{ matrix.suffix }}.tar.gz

  # Native builds for Unix (macOS)
  build-unix:
    runs-on: macos-latest
    env:
      RUST_BACKTRACE: full
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-apple-darwin
            features: ""
          - target: x86_64-apple-darwin
            features: "--all-features"
            suffix: "-full-features"
          - target: aarch64-apple-darwin
            features: ""
          - target: aarch64-apple-darwin
            features: "--all-features"
            suffix: "-full-features"
    steps:
      - name: Setup | Checkout
        uses: actions/checkout@v5

      - name: Setup | Protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup | Cache Cargo
        uses: actions/cache@v4.2.0
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Setup | Cache Cargo Target
        uses: actions/cache@v4.2.0
        with:
          path: target
          key: ${{ matrix.target }}-cargo-target

      - name: Setup | Rust
        run: |
          rustup set profile minimal
          rustup toolchain install stable
          rustup default stable
          rustup override set stable
          rustup target add --toolchain stable ${{ matrix.target }}

      - name: Build | Native build ${{ matrix.target }}
        shell: bash
        run: |
          cargo build --release --locked --target ${{ matrix.target }} --workspace ${{ matrix.features }}

      - name: PostBuild | Prepare artifacts
        run: |
          cd target/${{ matrix.target }}/release
          strip linkura-cli || true
          strip linkura-motion-cli || true

          suffix="${{ matrix.suffix }}"
          if [ -n "$suffix" ]; then
            cp linkura-cli linkura-cli${suffix}
            cp linkura-motion-cli linkura-motion-cli${suffix}
            tar czvf ../../../linkura-cli-${{ matrix.target }}${suffix}.tar.gz linkura-cli${suffix} linkura-motion-cli${suffix}
          else
            tar czvf ../../../linkura-cli-${{ matrix.target }}.tar.gz linkura-cli linkura-motion-cli
          fi
          cd -

      - name: Deploy | Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linkura-${{ matrix.target }}${{ matrix.suffix }}.tar.gz
          path: linkura-${{ matrix.target }}${{ matrix.suffix }}.tar.gz

  # Native builds for Windows
  build-windows:
    runs-on: windows-latest
    env:
      RUSTFLAGS: "-C target-feature=+crt-static"
      RUST_BACKTRACE: full
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-pc-windows-msvc
            features: ""
          - target: x86_64-pc-windows-msvc
            features: "--all-features"
            suffix: "-full-features"
    steps:
      - name: Setup | Checkout
        uses: actions/checkout@v5

      - name: Setup | Protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup | Rust
        run: |
          rustup set profile minimal
          rustup toolchain install stable
          rustup default stable
          rustup override set stable
          rustup target add --toolchain stable ${{ matrix.target }}

      - name: Build | Native build ${{ matrix.target }}
        run: |
          cargo build --release --locked --target ${{ matrix.target }} --workspace ${{ matrix.features }}

      - name: PostBuild | Prepare artifacts
        shell: bash
        run: |
          cd target/${{ matrix.target }}/release
          strip linkura-cli.exe || true
          strip linkura-motion-cli.exe || true

          suffix="${{ matrix.suffix }}"
          if [ -n "$suffix" ]; then
            cp linkura-cli.exe linkura-cli${suffix}.exe
            cp linkura-motion-cli.exe linkura-motion-cli${suffix}.exe
            7z a ../../../linkura-cli-${{ matrix.target }}${suffix}.zip linkura-cli${suffix}.exe linkura-motion-cli${suffix}.exe
          else
            7z a ../../../linkura-cli-${{ matrix.target }}.zip linkura-cli.exe linkura-motion-cli.exe
          fi
          cd -

      - name: Deploy | Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linkura-cli-${{ matrix.target }}${{ matrix.suffix }}.zip
          path: linkura-cli-${{ matrix.target }}${{ matrix.suffix }}.zip